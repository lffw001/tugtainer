<p-toolbar>
  <ng-template #start>
    <p-iconfield iconPosition="left">
      <p-inputicon>
        <i class="pi pi-search"></i>
      </p-inputicon>
      <input
        #searchInput
        id="{{ host()?.id }}-containers-search"
        pInputText
        type="text"
        (input)="dt2.filterGlobal($event.target.value, 'contains')"
        [placeholder]="'CONTAINERS.SEARCH_PLACEHOLDER' | translate"
      />
    </p-iconfield>
    <p-button
      icon="pi pi-refresh"
      [loading]="list.isLoading()"
      text
      (onClick)="list.reload()"
    ></p-button>
  </ng-template>
  <ng-template #end>
    <p-button
      severity="success"
      icon="pi pi-spinner-dotted"
      [loading]="checkHostActive()"
      [label]="'CONTAINERS.CHECK_ALL' | translate"
      (onClick)="checkHost()"
    ></p-button>
  </ng-template>
</p-toolbar>

<p-table
  #dt2
  [globalFilterFields]="['name', 'container_id']"
  dataKey="name"
  sortMode="multiple"
  [multiSortMeta]="[
    { field: 'update_available', order: -1 },
    { field: 'name', order: 1 },
  ]"
  [scrollable]="true"
  scrollHeight="flex"
  [value]="list.value()"
  selectionMode="single"
>
  <ng-template #header>
    <tr>
      <th pSortableColumn="name">
        {{ 'CONTAINERS.NAME' | translate }}
        <p-sortIcon field="name"></p-sortIcon>
      </th>
      <th
        pSortableColumn="status"
        style="width: 10%"
      >
        {{ 'CONTAINERS.STATUS' | translate }}
        <p-sortIcon field="status"></p-sortIcon>
      </th>
      <th
        pSortableColumn="health"
        style="width: 10%"
      >
        {{ 'CONTAINERS.HEALTH' | translate }}
        <p-sortIcon field="health"></p-sortIcon>
      </th>
      <th
        pSortableColumn="check_enabled"
        style="width: 10%"
      >
        {{ 'CONTAINERS.CHECK_ENABLED' | translate }}
        <i
          class="pi pi-question-circle"
          style="margin: 0 0.5rem"
          [pTooltip]="'CONTAINERS.CHECK_HINT' | translate"
          tooltipPosition="left"
        ></i>
        <p-sortIcon field="check_enabled"></p-sortIcon>
      </th>
      <th
        pSortableColumn="update_enabled"
        style="width: 10%"
      >
        {{ 'CONTAINERS.UPDATE_ENABLED' | translate }}
        <i
          class="pi pi-question-circle"
          style="margin: 0 0.5rem"
          [pTooltip]="'CONTAINERS.UPDATE_HINT' | translate"
          tooltipPosition="left"
        ></i>
        <p-sortIcon field="update_enabled"></p-sortIcon>
      </th>
      <th
        pSortableColumn="update_available"
        style="width: 10%"
      >
        <i
          class="pi pi-question-circle"
          style="margin: 0 0.5rem"
          [pTooltip]="'CONTAINERS.MAIN_BTN_HINT' | translate"
          tooltipPosition="left"
        ></i>
        <p-sortIcon field="update_available"></p-sortIcon>
      </th>
    </tr>
  </ng-template>

  <ng-template
    #body
    let-container
  >
    <tr routerLink="/hosts/{{ container.host_id }}/{{ container.name || container.container_id }}">
      <td>
        {{ container.name }}
        @if (container.protected) {
          <p-tag
            severity="warn"
            icon="pi pi-lock"
            [value]="'CONTAINERS.PROTECTED' | translate"
            [pTooltip]="'CONTAINERS.PROTECTED_CONTAINER_HINT' | translate"
          >
          </p-tag>
        }
        @if (container.update_available) {
          <p-tag
            severity="success"
            icon="pi pi-check-circle"
            [value]="'CONTAINERS.UPDATE_AVAILABLE' | translate"
          ></p-tag>
        }
      </td>
      <td>
        <p-tag
          [severity]="EContainerStatusSeverity[container.status]"
          [value]="
            container.status == 'exited'
              ? container.status + ' ' + container.exit_code
              : container.status
          "
        ></p-tag>
      </td>
      <td>
        <p-tag
          [severity]="EContainerHealthSeverity[container.health] ?? 'secondary'"
          [value]="container.health"
        ></p-tag>
      </td>
      <td>
        <p-togglebutton
          severity="success"
          [ngModel]="container.check_enabled"
          (ngModelChange)="onCheckEnabledChange($event, container)"
          [onLabel]="'GENERAL.ON' | translate"
          [offLabel]="'GENERAL.OFF' | translate"
          [onIcon]="'pi pi-check-circle'"
          [offIcon]="'pi pi-circle-off'"
          (click)="$event.stopPropagation()"
        />
      </td>
      <td>
        @if (!container.protected) {
          <p-togglebutton
            [disabled]="!container.check_enabled"
            [ngModel]="container.update_enabled"
            (ngModelChange)="onUpdateEnabledChange($event, container)"
            [onLabel]="'GENERAL.ON' | translate"
            [offLabel]="'GENERAL.OFF' | translate"
            [onIcon]="'pi pi-check-circle'"
            [offIcon]="'pi pi-circle-off'"
            (click)="$event.stopPropagation()"
          />
        }
      </td>
      <td style="padding-right: 0;">
        <app-container-actions
          [item]="container"
          (onDone)="onContainerProgressDone()"
          (click)="$event.stopPropagation()"
        ></app-container-actions>
      </td>
    </tr>
  </ng-template>
</p-table>

<p-dialog
  [header]="'CONTAINERS.CHECK_ALL_COMPLETED' | translate"
  [modal]="true"
  [draggable]="false"
  [visible]="checkHostDialogVisible()"
  (visibleChange)="checkHostDialogVisible.set(false)"
>
  @if (checkHostProgress()?.result; as res) {
    <app-host-check-result [result]="res"></app-host-check-result>
  }
</p-dialog>
